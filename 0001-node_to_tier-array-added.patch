From 4a23d47314fd0b7c317f9922bd698b886d2f3dbc Mon Sep 17 00:00:00 2001
From: Hyun-sa <chminoo@g.cbnu.ac.kr>
Date: Sat, 16 Aug 2025 12:09:08 +0000
Subject: [PATCH] node_to_tier array added

---
 linux-6.15.6/Makefile                     |  2 +-
 linux-6.15.6/include/linux/memory-tiers.h |  1 +
 linux-6.15.6/mm/memory-tiers.c            | 28 +++++++++++++++++++++++
 3 files changed, 30 insertions(+), 1 deletion(-)

diff --git a/linux-6.15.6/Makefile b/linux-6.15.6/Makefile
index 959b55a05..5275087aa 100644
--- a/linux-6.15.6/Makefile
+++ b/linux-6.15.6/Makefile
@@ -2,7 +2,7 @@
 VERSION = 6
 PATCHLEVEL = 15
 SUBLEVEL = 6
-EXTRAVERSION =
+EXTRAVERSION = -cgtier
 NAME = Baby Opossum Posse
 
 # *DOCUMENTATION*
diff --git a/linux-6.15.6/include/linux/memory-tiers.h b/linux-6.15.6/include/linux/memory-tiers.h
index 0dc0cf286..a802c7cad 100644
--- a/linux-6.15.6/include/linux/memory-tiers.h
+++ b/linux-6.15.6/include/linux/memory-tiers.h
@@ -34,6 +34,7 @@ struct memory_dev_type {
 };
 
 struct access_coordinate;
+extern int* node_to_tier;
 
 #ifdef CONFIG_NUMA
 extern bool numa_demotion_enabled;
diff --git a/linux-6.15.6/mm/memory-tiers.c b/linux-6.15.6/mm/memory-tiers.c
index fc14fe53e..2e1e702b7 100644
--- a/linux-6.15.6/mm/memory-tiers.c
+++ b/linux-6.15.6/mm/memory-tiers.c
@@ -51,6 +51,8 @@ static const struct bus_type memory_tier_subsys = {
 	.dev_name = "memory_tier",
 };
 
+int* node_to_tier;
+
 #ifdef CONFIG_NUMA_BALANCING
 /**
  * folio_use_access_time - check if a folio reuses cpupid for page access time
@@ -273,6 +275,21 @@ static struct memory_tier *__node_get_memory_tier(int node)
 				     lockdep_is_held(&memory_tier_lock));
 }
 
+static int get_memtier_index(int node)
+{
+    struct memory_tier *target_memtier = __node_get_memory_tier(node);
+    struct memory_tier *current_memtier;
+    int index = 0;
+    list_for_each_entry(current_memtier, &memory_tiers, list) {
+        if (current_memtier == target_memtier) {
+            return index;
+        }
+        index++;
+    }
+
+    return -1;
+}
+
 #ifdef CONFIG_MIGRATION
 bool node_is_toptier(int node)
 {
@@ -721,6 +738,17 @@ static int __init memory_tier_late_init(void)
 	establish_demotion_targets();
 	put_online_mems();
 
+	node_to_tier = kcalloc(nr_node_ids, sizeof(int), GFP_KERNEL);
+	for (int i = 0; i < nr_node_ids; i++) {
+		if (node_state(i, N_ONLINE))
+			node_to_tier[i] = get_memtier_index(i);
+		else
+			node_to_tier[i] = -1;
+	}
+
+	for (int i = 0; i < nr_node_ids; i++) 
+		printk("[ALERT] Node [%d] : Tier [%d]\n", i, node_to_tier[i]);	
+
 	return 0;
 }
 late_initcall(memory_tier_late_init);
-- 
2.43.0

